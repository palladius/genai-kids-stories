#!/bin/bash

# Ricc: Initially copied from https://fly.io/ruby-dispatch/rails-on-docker/
#   (Also has a nice Dockerfile - worth copying)
# Also inspired by:
# - https://github.com/gilcierweb/rails-docker/blob/master/entrypoint.sh

set -euo pipefail

# Setting smart defaults
# This is what Cloud Run wants
export PORT="${PORT:-8080}"
# default is using postgres for DB + GCS for Storage
#export RAILS_ENV="${RAILS_ENV:-dev-on-gcp}"
export RAILS_ENV="${RAILS_ENV:-production}"

echo 'ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘'
echo "ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ genai-kids-stories docker entrypoint ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘"
echo 'ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘'
echo "ðŸ‘ PORT:                               '$PORT'"
echo "ðŸ‘ PROJECT_ID:                         '$PROJECT_ID'"
echo "ðŸ‘ APP_VERSION:                        '$APP_VERSION'"
echo "ðŸ‘ RAILS_ENV:                          '$RAILS_ENV'"
echo "ðŸ‘ GOOGLE_TRANSLATE_KEY (redacted):    '${GOOGLE_TRANSLATE_KEY:1:20}..'"
echo "ðŸ‘ DANGEROUS_SA_JSON_VALUE (redacted): '$(echo -en ${DANGEROUS_SA_JSON_VALUE:1:50})..'"
echo 'ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘'

# If running the rails server then create or migrate existing database
if [ "${*}" == "./bin/rails server" ]; then
  ./bin/rails db:prepare
  # Then continue...
fi

#if [ "${*}" == "" ]; then
  echo '01. You were too lazy to give me any var. No probs, sit back and relax, Ricc will do it for you'
  #echo ./bin/rails db:prepare

  # Great ideas from https://github.com/gilcierweb/rails-docker/blob/master/entrypoint.sh
  # Checking PostgreS is ready:
  echo "02. Chekcing that postgreS is ready.."
  while ! pg_isready -q -h $APP_DB_HOST -U $APP_DB_USER ; do
    echo "$(date) ðŸ”‹ waiting for PG DB ($APP_DB_HOST) to start.."
    sleep 2
  done


  # TODO obly execute if needed (from ENV=prod or from RAILS_SERVE_STATIC_FILES ? )
  echo "04. Assets precomp in PROD :)"
  rails assets:precompile

  echo "05. Deleting server.pid file..."
  rm -f /tmp/pids/server.pid

  # I pray Ill be able soon to remove this and use APIs instead of gcloud :)
  echo "06. Setting up gcloud (TODO remove)"
  #echo TODO gcloud config set account  TODOricc
#  if [ ! -f /sa.json ] ; then
  if [ ! -s /sa.json ] ; then # file not empty
   echo "$DANGEROUS_SA_JSON_VALUE" > /sa.json
   echo "File /sa.json just created."
  else
    echo POintless. File /sa.json already present
  fi
  gcloud auth activate-service-account --key-file  /sa.json
  gcloud config configurations list


  echo "13. Running database migrations AFTER setting up gcloud..."
  bundle exec rails db:migrate 2>/dev/null || bundle exec rails db:create db:migrate
  echo ".. Finished running database migrations."


  echo "99. Finally starting rails server..."
  rails s -b 0.0.0.0 -p "$PORT"
 # exit 0
#fi

# else
echo "ðŸŒ± Entrypoint ðŸŒ± Executing now this command: '$@'"
exec "${@}"
