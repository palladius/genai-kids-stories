#!/bin/bash

# Ricc: Initially copied from https://fly.io/ruby-dispatch/rails-on-docker/
#   (Also has a nice Dockerfile - worth copying)
# Also inspired by:
# - https://github.com/gilcierweb/rails-docker/blob/master/entrypoint.sh

set -eo pipefail

# Setting smart defaults
# This is what Cloud Run wants
export PORT="${PORT:-8080}"
# This GalaxyQuest quote enables the long
export ACTIVATE_OMEGA13="${ACTIVATE_OMEGA13:-false}"
# default is using postgres for DB + GCS for Storage
#export RAILS_ENV="${RAILS_ENV:-dev-on-gcp}"
export RAILS_ENV="${RAILS_ENV:-production}"

export RAILS_LOG_TO_STDOUT='1'
export RAILS_SERVE_STATIC_FILES="true"
#export BUNDLE_WITHOUT="development"

# Since we are in prod...
APP_DB_HOST=${APP_DB_HOST:=$PROD_DB_HOST}
APP_DB_USER=${APP_DB_USER:=$PROD_DB_USER}
APP_DB_PASS=${APP_DB_PASS:=$PROD_DB_PASS}
APP_DB_NAME=${APP_DB_NAME:=$PROD_DB_NAME}

echo 'ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘'
echo "ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ genai-kids-stories docker entrypoint ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘"
echo 'ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘'
echo "ðŸ‘ Entrypoint ARGS:                    '$*'"
echo "ðŸ‘ PORT:                               '$PORT'"
echo "ðŸ‘ PROJECT_ID:                         '$PROJECT_ID'"
#echo "ðŸ‘ AI_PROJECT_ID:                      '$AI_PROJECT_ID'"
echo "ðŸ‘ APP_VERSION:                        '$APP_VERSION'"
echo "ðŸ‘ RAILS_ENV:                          '$RAILS_ENV'"
echo "ðŸ‘ GOOGLE_TRANSLATE_KEY (redacted):    '${GOOGLE_TRANSLATE_KEY:1:20}..'"
echo "ðŸ‘ DANGEROUS_SA_JSON_VALUE (redacted): '$(echo -en ${DANGEROUS_SA_JSON_VALUE:1:50})..'"
echo 'ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘ðŸ‘'

# If running the rails server then create or migrate existing database
if [ "${*}" == "./bin/rails server" ]; then
  ./bin/rails db:prepare
  # Then continue...
fi



##########################################################
# No argument: plenty of actions.
# 1 argument? Skip to it (for bash and other stuff)
##########################################################
# https://www.youtube.com/watch?v=frN4MU-8JNw
#ACTIVATE_OMEGA13=true
if [ "${*}" == "" -o "${*}" == "echo activate omega13" -o "true" == "$ACTIVATE_OMEGA13" ]; then
  echo 'ðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒ'
  echo 'ðŸŒŒ Omega13 enabled! ðŸŒŒ'
  echo 'ðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒðŸŒŒ'

  echo '01. [â„¦13] You were too lazy to give me any var. No probs, sit back and relax, Ricc will do all the magic for you'

  # Great ideas from https://github.com/gilcierweb/rails-docker/blob/master/entrypoint.sh
  # Checking PostgreS is ready:
  echo "02. Checking that postgreS is ready.."
  while ! pg_isready -q -h "$APP_DB_HOST" -U "$APP_DB_USER" ; do
    echo "$(date) [$RAILS_ENV]ðŸ”‹ waiting for PG DB (host='$APP_DB_HOST') to start.."
    sleep 2
  done
  echo 'ðŸ‘ PostgreS works!'


  # TODO obly execute if needed (from ENV=prod or from RAILS_SERVE_STATIC_FILES ? )
  echo "04. Assets precomp in PROD :)"
  rails assets:precompile

  echo "05. Deleting server.pid file..."
  rm -f /tmp/pids/server.pid

  # I pray Ill be able soon to remove this and use APIs instead of gcloud :)
  echo "06. Setting up gcloud (TODO remove)"
  #echo TODO gcloud config set account  TODOricc
#  if [ ! -f /sa.json ] ; then

  # ls -al /sa.json
  if [ ! -s /sa.json ] ; then # file not empty
   echo "$DANGEROUS_SA_JSON_VALUE" > /sa.json
   echo "ðŸ‘ File /sa.json just created."
  else
    echo Pointless. File /sa.json already present.
  fi
  # if [ -d /rails/private/ ]; then
  #   # Dockerized version...
  #    echo "$DANGEROUS_SA_JSON_VALUE" > /rails/private/sa.json
  # fi
  gcloud auth activate-service-account --key-file  /sa.json ||
    echo Maybe you dont need this
  gcloud config configurations list
  gcloud auth print-access-token >/dev/null
  echo 'ðŸ‘ gcloud auth print-access-token succesful!!!'


  echo "13. Running database migrations AFTER setting up gcloud..."
  bundle exec rails db:migrate 2>/dev/null || bundle exec rails db:create db:migrate
  echo "ðŸ‘.. Finished running database migrations."

  echo "ðŸŒ±99.ðŸŒ± No arg given to entrypoint => Starting rails server..."
  rails s -b 0.0.0.0 -p "$PORT"
else
  echo "ðŸŒ±99.ðŸŒ± Non-empty Entrypoint ðŸŒ± Executing now this command: '$@'"
  exec "${@}"
fi

echo "Exiting entrypoint succesfully. What a ride!"
